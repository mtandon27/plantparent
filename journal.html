<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Plant Parent - Journal</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üå±</text></svg>"
    />
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="global.css" />

  </head>

  <body>
    <nav>
      <a href="index.html" class="nav-brand"><span>üå± PLANT PARENT</span></a>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="browse.html">Explore</a></li>
        <li><a href="journal.html" class="active">Journal</a></li>
      </ul>
    </nav>

    <div class="full-width-container">
      <div class="page-header">
        <h1>Plant Log</h1>
        <p
          class="subtitle"
          style="
            background: var(--color-highlight);
            display: inline-block;
            padding: 2px 10px;
            transform: rotate(-1deg);
          "
        >
          Tracking growth, one leaf at a time.
        </p>
      </div>

      <div class="journal-container">
        <aside class="quest-board">
          <h2
            style="
              font-family: var(--font-heading);
              border-bottom: 2px dashed #ccc;
              padding-bottom: 10px;
              margin-bottom: 1rem;
            "
          >
            Daily Quests
          </h2>
          <div
            class="daily-quest"
            style="
              background: #e3f2fd;
              padding: 1rem;
              border: 2px solid var(--color-ink);
              margin-bottom: 2rem;
            "
          >
            <h3 style="font-size: 1.2rem">‚ú® Mindful Moment</h3>
            <p
              id="daily-mindfulness"
              style="font-style: italic; margin: 10px 0"
            >
              Loading quest...
            </p>
            <button class="quest-btn" onclick="completeQuest(this)">
              Complete ‚úÖ
            </button>
          </div>

          <h3 style="font-family: var(--font-heading)">Badges</h3>

          <div
            style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 1rem"
          >
            <div
              class="sticker"
              style="transform: rotate(-5deg)"
              data-tooltip="Hydration Hero: Watered 5 days streak"
            >
              üíß
            </div>
            <div
              class="sticker"
              style="transform: rotate(3deg)"
              data-tooltip="New Parent: Adopted first plant"
            >
              üå±
            </div>
            <div
              class="sticker"
              style="transform: rotate(-2deg)"
              data-tooltip="Plant Doctor: Saved a dying plant"
            >
              ‚ù§Ô∏è
            </div>
            <div
              class="sticker"
              style="
                transform: rotate(5deg);
                opacity: 0.3;
                filter: grayscale(1);
              "
              data-tooltip="Locked: Collect 10 Plants to unlock"
            >
              üèÜ
            </div>
            <div
              class="sticker"
              style="
                transform: rotate(-3deg);
                opacity: 0.3;
                filter: grayscale(1);
              "
              data-tooltip="Locked: Keep a plant alive for 1 month"
            >
              üìÖ
            </div>
          </div>
        </aside>

        <main class="journal-grid" id="journalGrid">
          </main>
      </div>
    </div>

    <div class="modal-overlay" id="addEntryModal">
      <div class="modal-content">
        <button class="close-modal" onclick="closeAddModal()">√ó</button>
        <h2 style="font-family: var(--font-heading); margin-bottom: 1rem; color: var(--color-accent);">
          New Journal Entry
        </h2>
        <div style="display: flex; flex-direction: column; gap: 1rem">
          <div>
            <label style="font-family: var(--font-heading)">Which Plant?</label>
            <select
              id="plantSelect"
              style="width: 100%; padding: 8px; font-size: 1.1rem; border: 2px solid var(--color-ink);"
            >
              <option value="" disabled selected>Select from your garden...</option>
            </select>
          </div>
          <div>
            <label style="font-family: var(--font-heading)">Today's Note</label>
            <textarea
              id="newEntryText"
              rows="3"
              style="width: 100%; padding: 8px; font-size: 1.1rem; border: 2px solid var(--color-ink);"
              placeholder="How is it doing today?"
            ></textarea>
          </div>
          <button class="primary-btn" onclick="submitNewEntry()">Add to Journal</button>
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="editCardModal">
      <div class="modal-content">
        <button class="close-modal" onclick="closeEditModal()">√ó</button>
        <h2 style="font-family: var(--font-heading); margin-bottom: 1rem; color: var(--color-accent);">
          Edit Entry
        </h2>

        <div style="display: flex; flex-direction: column; gap: 1rem">
          <input type="hidden" id="originalName">

          <div>
            <label style="font-family: var(--font-heading)">Plant Name</label>
            <input
              type="text"
              id="editName"
              style="width: 100%; padding: 8px; font-size: 1.1rem; border: 2px solid var(--color-ink);"
            />
          </div>

          <div>
            <label style="font-family: var(--font-heading)">Update Photo</label>
            <label class="file-upload-label">
                üìÇ Upload from Device
                <input type="file" id="editImgFile" accept="image/*" style="display: none;" onchange="document.getElementById('file-name-display').innerText = this.files[0].name">
            </label>
            <p id="file-name-display" style="font-size: 0.8rem; color: #666; margin-top: 5px; text-align:center;">No file chosen</p>
            <p style="text-align: center; font-family: var(--font-heading); margin: 5px 0;">- OR -</p>
            <input type="text" id="editImgUrl" placeholder="Paste Image Link..." style="width: 100%; padding: 8px; font-size: 1rem; border: 1px solid #ccc;" />
          </div>

          <div>
            <label style="font-family: var(--font-heading)">Note</label>
            <textarea
              id="editNote"
              rows="3"
              style="width: 100%; padding: 8px; font-size: 1.1rem; border: 2px solid var(--color-ink);"
            ></textarea>
          </div>

          <button class="primary-btn" onclick="saveEditChanges()">Save Changes</button>
          
          <button class="delete-btn" onclick="deleteEntry()">üóëÔ∏è Delete Plant</button>
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="historyModal">
      <div class="modal-content notebook-paper">
        <button class="close-modal" onclick="closeHistoryModal()">X</button>
        <h2 id="historyTitle" style="font-family: var(--font-heading); margin-bottom: 1.5rem; color: var(--color-ink); text-decoration: underline;">
          Plant History
        </h2>
        <div id="historyList"></div>
      </div>
    </div>

    <footer>
      <p style="font-family: var(--font-heading); font-size: 1.2rem; margin: 0">
        &copy; 2025 Manvi Tandon. All rights reserved.
      </p>
    </footer>

    <script>
      /* --- INIT & CARD GENERATION --- */
      document.addEventListener('DOMContentLoaded', loadJournal);

      async function loadJournal() {
        const grid = document.getElementById('journalGrid');
        
        // --- DEFAULT DATA WITH CUSTOM IMAGES ---
        const defaultPlants = [
            { 
                name: "Monstera Deliciosa", 
                image: "assets/MonsteraJournal.webp", // Custom Image
                note: "New leaf unfurling today! It's slightly lighter green than the others." 
            },
            { 
                name: "Golden Pothos", 
                image: "assets/pothos.jpg", // Custom Image
                note: "Moved to the window sill for better light." 
            }
        ];

        let myGarden = JSON.parse(localStorage.getItem('myPlants'));
        
        // If empty or null, use default
        if (!myGarden || myGarden.length === 0) {
            myGarden = defaultPlants; 
            localStorage.setItem('myPlants', JSON.stringify(myGarden));
        }

        grid.innerHTML = '';

        myGarden.forEach(plant => {
            const card = document.createElement('div');
            card.className = 'entry-card';
            card.style.setProperty('--rotation', (Math.random() * 4 - 2) + 'deg');

            const imgSrc = plant.image || '';
            const noteText = plant.note || "No notes yet.";

            card.innerHTML = `
                <div class="tape"></div>
                <div class="polaroid-img" onclick="openHistory('${plant.name}')" title="Click to view history">
                    <img class="card-img-tag" src="${imgSrc}" onerror="handleImgError(this)" style="${imgSrc ? '' : 'display:none'}">
                    <span class="img-fallback" style="${imgSrc ? '' : 'display:block'}">üåø</span>
                </div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top: 5px;">
                    <div style="display:flex; align-items:center;">
                        <h3 class="card-name" style="font-family: var(--font-heading); font-size: 1.4rem; margin:0;">${plant.name}</h3>
                        <button class="edit-btn" onclick="openEditModal(this)" title="Edit Plant">‚úé</button>
                    </div>
                    <span style="font-size: 0.9rem; color:#888;">Today</span>
                </div>

                <div class="care-tracker">
                    <button class="care-btn" data-type="water" data-tooltip="Watered" onclick="toggleCare(this)">üíß</button>
                    <button class="care-btn" data-type="sun" data-tooltip="Sunlight" onclick="toggleCare(this)">‚òÄÔ∏è</button>
                    <button class="care-btn" data-type="food" data-tooltip="Fertilized" onclick="toggleCare(this)">üß™</button>
                </div>

                <textarea class="journal-input card-note">${noteText}</textarea>
                
                <div class="mood-tracker">
                    <span style="font-size:0.9rem; font-family:var(--font-heading);">Mood:</span>
                    <div class="mood-options">
                        <button class="mood-btn" title="Struggling" onclick="setMood(this)">üò´</button>
                        <button class="mood-btn" title="Neutral" onclick="setMood(this)">üòê</button>
                        <button class="mood-btn" title="Calm" onclick="setMood(this)">üòå</button>
                        <button class="mood-btn" title="Energetic" onclick="setMood(this)">‚ö°</button>
                        <button class="mood-btn" title="Thriving" onclick="setMood(this)">üåø</button>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });

        const addCard = document.createElement('div');
        addCard.className = 'entry-card add-new-card';
        addCard.onclick = openAddModal;
        addCard.innerHTML = `
            <div style="text-align: center;">
                <div style="font-size: 3rem; color: #aaa;">+</div>
                <p style="font-family: var(--font-heading); color: #aaa;">Log New Plant</p>
            </div>
        `;
        grid.appendChild(addCard);
      }

      /* --- EDIT ENTRY LOGIC --- */
      let currentCardBeingEdited = null;
      const editModal = document.getElementById("editCardModal");
      const editNameInput = document.getElementById("editName");
      const editImgUrlInput = document.getElementById("editImgUrl");
      const editImgFileInput = document.getElementById("editImgFile");
      const editNoteInput = document.getElementById("editNote");
      const originalNameInput = document.getElementById("originalName");

      function openEditModal(btn) {
        currentCardBeingEdited = btn.closest(".entry-card");
        const currentName = currentCardBeingEdited.querySelector(".card-name").innerText;
        const currentNote = currentCardBeingEdited.querySelector(".card-note").value;

        editNameInput.value = currentName;
        originalNameInput.value = currentName; 
        editNoteInput.value = currentNote;
        editImgUrlInput.value = "";
        editImgFileInput.value = "";
        document.getElementById('file-name-display').innerText = "No file chosen";

        editModal.classList.add("open");
      }

      function closeEditModal() {
        editModal.classList.remove("open");
        currentCardBeingEdited = null;
      }

      function saveEditChanges() {
        if (!currentCardBeingEdited) return;

        const oldName = originalNameInput.value;
        const newName = editNameInput.value;
        const newNote = editNoteInput.value;
        const file = editImgFileInput.files[0];
        
        const performSave = (imgData) => {
            currentCardBeingEdited.querySelector(".card-name").innerText = newName;
            currentCardBeingEdited.querySelector(".card-note").value = newNote;
            
            if (imgData) {
                const imgTag = currentCardBeingEdited.querySelector(".card-img-tag");
                imgTag.src = imgData;
                imgTag.style.display = "block";
                currentCardBeingEdited.querySelector(".img-fallback").style.display = "none";
            }

            let myPlants = JSON.parse(localStorage.getItem("myPlants")) || [];
            const plantIndex = myPlants.findIndex(p => p.name === oldName);
            
            if (plantIndex !== -1) {
                myPlants[plantIndex].name = newName;
                myPlants[plantIndex].note = newNote;
                if (imgData) myPlants[plantIndex].image = imgData;
                localStorage.setItem("myPlants", JSON.stringify(myPlants));
            }
            closeEditModal();
        };

        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) { performSave(e.target.result); }
            reader.readAsDataURL(file);
        } 
        else if (editImgUrlInput.value.trim() !== "") {
            performSave(editImgUrlInput.value);
        } 
        else {
            performSave(null);
        }
      }

      function deleteEntry() {
        const nameToDelete = originalNameInput.value;
        if (confirm(`Are you sure you want to remove ${nameToDelete} from your journal?`)) {
            let myPlants = JSON.parse(localStorage.getItem("myPlants")) || [];
            myPlants = myPlants.filter(p => p.name !== nameToDelete);
            localStorage.setItem("myPlants", JSON.stringify(myPlants));
            closeEditModal();
            loadJournal();
        }
      }

      /* --- OTHER LOGIC --- */
      function completeQuest(btn) {
        const rect = btn.getBoundingClientRect();
        const x = (rect.left + rect.width / 2) / window.innerWidth;
        const y = (rect.top + rect.height / 2) / window.innerHeight;
        confetti({ particleCount: 150, spread: 70, origin: { x: x, y: y }, colors: ["#2d6a4f", "#fab1a0", "#ffeaa7", "#95d5b2"] });
        btn.disabled = true;
        btn.innerText = "Done! +XP";
      }

      const addModal = document.getElementById("addEntryModal");
      function openAddModal() {
        addModal.classList.add("open");
        loadUserPlants(); 
      }
      function closeAddModal() { addModal.classList.remove("open"); }

      function loadUserPlants() {
        const select = document.getElementById("plantSelect");
        select.innerHTML = '<option value="" disabled selected>Select from your garden...</option>';
        let myPlants = JSON.parse(localStorage.getItem("myPlants")) || [];
        myPlants.forEach((plant) => {
          let option = document.createElement("option");
          option.value = plant.name;
          option.text = plant.name;
          select.appendChild(option);
        });
      }

      function submitNewEntry() {
        const plantName = document.getElementById("plantSelect").value;
        const note = document.getElementById("newEntryText").value;
        if (!plantName) return alert("Select a plant!");

        let myPlants = JSON.parse(localStorage.getItem("myPlants"));
        const plantIndex = myPlants.findIndex(p => p.name === plantName);
        if(plantIndex !== -1) {
            myPlants[plantIndex].note = note;
            localStorage.setItem("myPlants", JSON.stringify(myPlants));
        }
        closeAddModal();
        loadJournal(); 
      }

      function handleImgError(img) {
        img.style.display = "none";
        img.nextElementSibling.style.display = "block";
      }
      function toggleCare(btn) { btn.classList.toggle("active"); }
      function setMood(btn) {
        btn.parentElement.querySelectorAll(".mood-btn").forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
      }

      /* --- HISTORY WITH CUSTOM IMAGES AND RICH DATA --- */
      const plantHistoryData = {
        "Monstera Deliciosa": [
          {
            date: "Oct 20, 2025",
            note: "A new fenestrated leaf finally opened up! It's beautiful.",
            care: ["‚òÄÔ∏è", "üíß"],
            mood: "üåø",
            image: "assets/MonsteraJournal.webp" // History image matched
          },
          {
            date: "Oct 15, 2025",
            note: "Rotated the pot 90 degrees to keep growth even.",
            care: ["‚òÄÔ∏è"],
            mood: "üòå",
          },
          {
            date: "Oct 10, 2025",
            note: "Wiped dust off leaves. It looks shinier!",
            care: ["üíß", "‚òÄÔ∏è"],
            mood: "üòå",
          }
        ],
        "Golden Pothos": [
          {
            date: "Oct 18, 2025",
            note: "Leaves looked a bit droopy. Perked right up after water.",
            care: ["üíß"],
            mood: "üòå",
            image: "assets/pothos.jpg" // History image matched
          },
          {
            date: "Oct 01, 2025",
            note: "Watering day. Added a drop of fertilizer.",
            care: ["üíß", "üß™"],
            mood: "‚ö°",
          }
        ],
      };

      function openHistory(name) {
        document.getElementById("historyModal").classList.add("open");
        document.getElementById("historyTitle").innerText = "History: " + name;
        const list = document.getElementById("historyList");
        list.innerHTML = ""; 

        const logs = plantHistoryData[name] || [{ date: "Today", note: "Started tracking this plant.", care: [], mood: "üå±" }];
        
        logs.forEach(log => {
            const entry = document.createElement('div');
            entry.className = 'history-entry';
            
            let imgHtml = '';
            if (log.image) {
                imgHtml = `<div style="margin-top:10px;"><img src="${log.image}" style="max-width:100%; max-height:200px; border:2px solid #eee; border-radius:4px; object-fit:cover;"></div>`;
            }

            entry.innerHTML = `
                <div style="background:var(--color-ink); color:white; display:inline-block; padding:0 5px; transform:rotate(-2deg); font-family:var(--font-heading);">${log.date}</div>
                <div style="float:right;">${log.care.join(" ")} | Mood: ${log.mood}</div>
                <p style="margin-top:5px;">${log.note}</p>
                ${imgHtml}
                <hr style="border:0; border-bottom:1px dashed #ccc; margin:10px 0;">
            `;
            list.appendChild(entry);
        });
      }
      function closeHistoryModal() { document.getElementById("historyModal").classList.remove("open"); }

      window.onclick = function (event) {
        if (event.target == addModal) closeAddModal();
        if (event.target == document.getElementById("historyModal")) closeHistoryModal();
        if (event.target == editModal) closeEditModal();
      };
      
      const quests = ["Mist leaves.", "Rotate pot.", "Check soil moisture."];
      document.getElementById("daily-mindfulness").innerText = quests[Math.floor(Math.random() * quests.length)];
    </script>
  </body>
</html>